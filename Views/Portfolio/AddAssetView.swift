import SwiftUI

struct AddAssetView: View {
    @Environment(\.dismiss) private var dismiss
    @EnvironmentObject var portfolioManager: PortfolioManager
    @StateObject private var priceManager = PriceManager() // üÜï Para buscar pre√ßos
    
    @State private var symbol = ""
    @State private var name = ""
    @State private var assetType: Asset.AssetType = .bank
    @State private var quantity = ""
    @State private var purchasePrice = ""
    @State private var currentPrice = ""
    @State private var recordAsExpense = true
    @State private var annualInterestRate = ""
    
    // üÜï Estados para controle de pre√ßos
    @State private var isLoadingCurrentPrice = false
    @State private var hasLoadedInitialPrice = false
    @State private var showingPriceHelp = false
    
    var body: some View {
        NavigationView {
            Form {
                Section(header: Text("Informa√ß√µes do Ativo")) {
                    TextField(symbolPlaceholder, text: $symbol)
                        .textInputAutocapitalization(.characters)
                        .onChange(of: symbol) { _, newValue in
                            // üÜï Buscar pre√ßo automaticamente quando s√≠mbolo muda
                            if shouldFetchPrice(for: assetType) && !newValue.isEmpty {
                                fetchCurrentPrice()
                            }
                        }
                    
                    TextField(namePlaceholder, text: $name)
                    
                    Picker("Tipo", selection: $assetType) {
                        ForEach(Asset.AssetType.allCases, id: \.self) { type in
                            Text(type.rawValue).tag(type)
                        }
                    }
                    .onChange(of: assetType) { oldValue, newValue in
                        symbol = ""
                        name = ""
                        quantity = ""
                        purchasePrice = ""
                        currentPrice = ""
                        annualInterestRate = ""
                        hasLoadedInitialPrice = false
                    }
                }
                
                Section(header: Text("Valores")) {
                    TextField(quantityLabel, text: $quantity)
                        .keyboardType(.decimalPad)
                    
                    // üÜï NOVA SE√á√ÉO: Pre√ßos com explica√ß√£o
                    VStack(alignment: .leading, spacing: 8) {
                        HStack {
                            Text("Valor Atual do Mercado")
                                .font(.caption)
                                .foregroundColor(.secondary)
                            
                            Spacer()
                            
                            if shouldFetchPrice(for: assetType) {
                                Button(action: { showingPriceHelp = true }) {
                                    Image(systemName: "questionmark.circle")
                                        .font(.caption)
                                        .foregroundColor(.blue)
                                }
                                
                                if isLoadingCurrentPrice {
                                    ProgressView()
                                        .scaleEffect(0.7)
                                } else {
                                    Button("üîÑ") {
                                        fetchCurrentPrice()
                                    }
                                    .font(.caption)
                                }
                            }
                        }
                        
                        HStack {
                            TextField("Valor atual (‚Ç¨)", text: $currentPrice)
                                .keyboardType(.decimalPad)
                            
                            if shouldFetchPrice(for: assetType) && !symbol.isEmpty {
                                Button("Buscar Pre√ßo") {
                                    fetchCurrentPrice()
                                }
                                .font(.caption)
                                .disabled(isLoadingCurrentPrice)
                            }
                        }
                    }
                    
                    // üÜï NOVA SE√á√ÉO: Pre√ßo de compra com explica√ß√£o
                    VStack(alignment: .leading, spacing: 8) {
                        HStack {
                            Text("Valor de Compra")
                                .font(.caption)
                                .foregroundColor(.secondary)
                            
                            Button(action: copyCurrentToPurchase) {
                                Text("Copiar do atual")
                                    .font(.caption)
                                    .foregroundColor(.blue)
                            }
                            .disabled(currentPrice.isEmpty)
                        }
                        
                        TextField("Valor pago na compra (‚Ç¨)", text: $purchasePrice)
                            .keyboardType(.decimalPad)
                        
                        if !currentPrice.isEmpty && !purchasePrice.isEmpty,
                           let current = Double(currentPrice),
                           let purchase = Double(purchasePrice),
                           current != purchase {
                            
                            let difference = current - purchase
                            let percentageChange = (difference / purchase) * 100
                            
                            HStack {
                                Image(systemName: difference >= 0 ? "arrow.up.circle.fill" : "arrow.down.circle.fill")
                                    .foregroundColor(difference >= 0 ? .green : .red)
                                    .font(.caption)
                                
                                Text("Diferen√ßa: \(abs(difference).toCurrency()) (\(abs(percentageChange).toPercentage()))")
                                    .font(.caption)
                                    .foregroundColor(difference >= 0 ? .green : .red)
                            }
                        }
                    }
                }
                
                // üÜï Se√ß√£o de configura√ß√£o de juros (apenas para tipo .interest)
                if assetType == .interest {
                    Section(header: Text("Configura√ß√£o de Juros")) {
                        HStack {
                            TextField("Taxa de juros anual", text: $annualInterestRate)
                                .keyboardType(.decimalPad)
                            Text("%")
                                .foregroundColor(.secondary)
                        }
                        
                        if let rate = Double(annualInterestRate), let amount = Double(currentPrice) {
                            let monthlyInterest = (amount * rate / 12 / 100)
                            VStack(alignment: .leading, spacing: 4) {
                                Text("Juros mensais estimados: \(monthlyInterest.toCurrency())")
                                    .font(.caption)
                                    .foregroundColor(.green)
                                
                                Text("Juros anuais estimados: \((amount * rate / 100).toCurrency())")
                                    .font(.caption)
                                    .foregroundColor(.blue)
                            }
                        }
                        
                        Text("Os juros ser√£o calculados e adicionados automaticamente ao final de cada m√™s.")
                            .font(.caption)
                            .foregroundColor(.secondary)
                    }
                }
                
                Section(header: Text("Contabilidade")) {
                    Toggle("Registrar como despesa automaticamente", isOn: $recordAsExpense)
                    
                    if recordAsExpense {
                        Text("Esta compra ser√° automaticamente registrada como despesa nas suas transa√ß√µes.")
                            .font(.caption)
                            .foregroundColor(.secondary)
                    }
                }
                
                // üÜï Resumo melhorado
                if let qty = Double(quantity) {
                    Section(header: Text("Resumo")) {
                        if let purchasePrice = Double(purchasePrice) {
                            HStack {
                                Text("Valor Total do Investimento:")
                                Spacer()
                                Text((qty * purchasePrice).toCurrency())
                                    .fontWeight(.bold)
                                    .foregroundColor(.blue)
                            }
                        }
                        
                        if let currentPrice = Double(currentPrice) {
                            HStack {
                                Text("Valor Atual do Portfolio:")
                                Spacer()
                                Text((qty * currentPrice).toCurrency())
                                    .fontWeight(.bold)
                                    .foregroundColor(.green)
                            }
                        }
                        
                        if let current = Double(currentPrice),
                           let purchase = Double(purchasePrice) {
                            let totalDifference = qty * (current - purchase)
                            
                            HStack {
                                Text(totalDifference >= 0 ? "Lucro Atual:" : "Preju√≠zo Atual:")
                                Spacer()
                                Text(abs(totalDifference).toCurrency())
                                    .fontWeight(.bold)
                                    .foregroundColor(totalDifference >= 0 ? .green : .red)
                            }
                        }
                        
                        if recordAsExpense {
                            HStack {
                                Text("Ser√° registrado como:")
                                Spacer()
                                Text(getCategoryForAssetType(assetType))
                                    .foregroundColor(.orange)
                            }
                        }
                    }
                }
                
                Section(header: Text("Dicas")) {
                    Text(getTipsForAssetType())
                        .font(.caption)
                        .foregroundColor(.secondary)
                }
            }
            .navigationTitle("Adicionar \(assetType.rawValue)")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarLeading) {
                    Button("Cancelar") { dismiss() }
                }
                
                ToolbarItem(placement: .navigationBarTrailing) {
                    Button("Salvar") {
                        saveAsset()
                    }
                    .disabled(!isValidForm)
                }
            }
            .alert("Sobre os Pre√ßos", isPresented: $showingPriceHelp) {
                Button("OK") { }
            } message: {
                Text("‚Ä¢ Valor Atual: Pre√ßo do ativo no mercado neste momento\n‚Ä¢ Valor de Compra: Pre√ßo que pagou quando comprou o ativo\n\nA diferen√ßa entre estes valores mostra o seu lucro ou preju√≠zo atual.")
            }
        }
    }
    
    // üÜï Fun√ß√£o para determinar se deve buscar pre√ßo
    private func shouldFetchPrice(for type: Asset.AssetType) -> Bool {
        return type == .crypto || type == .stock || type == .interest
    }
    
    // üÜï Fun√ß√£o para buscar pre√ßo atual
    private func fetchCurrentPrice() {
        guard !symbol.isEmpty, shouldFetchPrice(for: assetType) else { return }
        
        isLoadingCurrentPrice = true
        
        Task {
            if let price = await priceManager.getCurrentPrice(for: symbol, type: assetType) {
                await MainActor.run {
                    currentPrice = String(price)
                    
                    // üÜï Se √© a primeira vez e n√£o h√° pre√ßo de compra, copiar automaticamente
                    if !hasLoadedInitialPrice && purchasePrice.isEmpty {
                        purchasePrice = String(price)
                    }
                    
                    hasLoadedInitialPrice = true
                    isLoadingCurrentPrice = false
                }
            } else {
                await MainActor.run {
                    isLoadingCurrentPrice = false
                }
            }
        }
    }
    
    // üÜï Fun√ß√£o para copiar pre√ßo atual para pre√ßo de compra
    private func copyCurrentToPurchase() {
        purchasePrice = currentPrice
    }
    
    // üÜï Dicas espec√≠ficas para cada tipo de ativo
    private func getTipsForAssetType() -> String {
        switch assetType {
        case .bank:
            return "üí° Para contas banc√°rias, use o saldo atual como valor. O valor de compra pode ser o dep√≥sito inicial."
        case .savings:
            return "üí° Para poupan√ßas, use o valor atual como saldo. O valor de compra √© quanto depositou inicialmente."
        case .crypto:
            return "üí° O valor atual √© obtido automaticamente da CoinMarketCap. Ajuste o valor de compra para o pre√ßo real que pagou."
        case .stock:
            return "üí° O valor atual √© obtido do mercado. Insira o pre√ßo real que pagou por cada a√ß√£o no valor de compra."
        case .interest:
            return "üí° Para obriga√ß√µes, o valor nominal √© usado. Ajuste o valor de compra se pagou pr√©mio ou desconto."
        }
    }
    
    private var symbolPlaceholder: String {
        switch assetType {
        case .bank: return "Ex: CONTA, CARTAO"
        case .savings: return "Ex: POUPANCA, COFRE"
        case .crypto: return "Ex: BTC, ETH, SOL"
        case .stock: return "Ex: AAPL, TSLA, MSFT"
        case .interest: return "Ex: CA, OT, DP"
        }
    }
    
    private var namePlaceholder: String {
        switch assetType {
        case .bank: return "Ex: Conta CGD, Cart√£o Millennium"
        case .savings: return "Ex: Conta Poupan√ßa, Mealheiro Casa"
        case .crypto: return "Ex: Bitcoin, Ethereum"
        case .stock: return "Ex: Apple Inc., Tesla"
        case .interest: return "Ex: Certificados Aforro, Obriga√ß√µes Tesouro"
        }
    }
    
    private var quantityLabel: String {
        switch assetType {
        case .bank, .savings, .interest: return "Quantidade (1 para conta √∫nica)"
        case .crypto: return "Quantidade (ex: 0.5 BTC)"
        case .stock: return "N√∫mero de a√ß√µes"
        }
    }
    
    private func getCategoryForAssetType(_ type: Asset.AssetType) -> String {
        switch type {
        case .bank: return "Transfer√™ncias Banc√°rias"
        case .savings: return "Poupan√ßas"
        case .crypto: return "Investimentos Cripto"
        case .stock: return "Investimentos A√ß√µes"
        case .interest: return "Investimentos Juros"
        }
    }
    
    private var isValidForm: Bool {
        let basicValidation = !symbol.isEmpty && !name.isEmpty &&
                             Double(quantity) != nil && Double(purchasePrice) != nil && Double(currentPrice) != nil
        
        if assetType == .interest {
            return basicValidation && Double(annualInterestRate) != nil
        }
        
        return basicValidation
    }
    
    private func saveAsset() {
        guard let qty = Double(quantity),
              let purchasePrice = Double(purchasePrice),
              let currentPrice = Double(currentPrice) else { return }
        
        let interestRate: Double? = assetType == .interest ? Double(annualInterestRate) : nil
        
        let asset = Asset(
            symbol: symbol.uppercased(),
            name: name,
            type: assetType,
            quantity: qty,
            averagePrice: purchasePrice, // üÜï Usar o pre√ßo de compra como custo m√©dio
            currentPrice: currentPrice,
            lastUpdated: Date(),
            annualInterestRate: interestRate,
            lastInterestPayment: nil
        )
        
        portfolioManager.addAsset(asset, recordExpense: recordAsExpense)
        dismiss()
    }
}
